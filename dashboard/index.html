<html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
	
	var json = [];
	var index = index || 1;
	
	function readTemps() {
	
		if(cpf) {
			var obj = [];
			var tempdata = cpf.get("temperature sensor");
			var Celsius = toCelsius(tempdata);
			
			var d = new Date();
			var time = d.getHours() + ":" +d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds();
			
			obj = {"key":index, "value": [{"date":time, "temperature":Celsius}]};
			json.push(obj);
			
			document.getElementById("temp").innerHTML = index;
			
			index += 1;
		}
		
		setTimeout("readTemps()", 1000);
	}
	
	function upload() {
		var str = JSON.stringify(json);
		aop.setStore("store1", str);
		alert("Upload Success!");
	}
	
	function download() {
	
		google.charts.load('current', {'packages':['corechart']});
		google.charts.setOnLoadCallback(drawChart);	
	
	}
	
	function drawChart() {
	
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Time of Day');
      data.addColumn('number', 'Temperature Data');
	  
	  var store = aop.getStore("store1");
	  var result = JSON.parse(store);
	  
	  for (var i = 0; i < result.length; i++){
		
		document.getElementById("test").innerHTML += result[i].value[0].temperature + ' ';
		
		data.addRows([
			[result[i].value[0].date, result[i].value[0].temperature]
		  ]);
		  
	  }

      var options = {
        title: 'Average Temperatures in Taipei Throughout a Day',
        width: 900,
        height: 500,
        vAxes: {
          // Adds titles to each axis.
          0: {title: 'Temps (Celsius)'}
        },
        vAxis: {
          viewWindow: {
            max: 40,
			min: 0
          }
        }
      };

      var chart = new google.visualization.LineChart(document.getElementById('dashboard'));

      chart.draw(data, options);
	  
    }
	
	// Temperature
	function toCelsius(value) {
		var resistance = parseFloat((1023-value) * 10000 / value);
		var temperature = 1 / (Math.log(resistance / 10000) / 3975+1 / 298.15) - 273.15;
		
		return Math.round(temperature * 100) / 100;
	}
	
	// cpf setup
	function setup(){
		if(cpf)
			var ret = cpf.setPinMode('[\"resetPin\"],[\"setPinMode\", \"analog\", 1,\"INPUT\"]'); 
	}
	
  </script>
</head>
<body>

	<div id="temp"></div>
	<div id="test"><div>
	<div style="margin-left: -40px; " id="dashboard"></div>
	
	<button style="height: 60px; width: 100px;" onclick="readTemps()">Read Temps</button>
	<button style="height: 60px; width: 100px;" onclick="upload()">Upload</button>
	<button style="height: 60px; width: 100px;" onclick="download()">Make Dashboard</button>
</body>
</html>